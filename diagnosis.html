<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Diagnosis Tools | RAGnosis</title>
  <link rel="stylesheet" href="./styles.css">
</head>
<body>
  <header>
    <div class="header-content">
      <div class="logo">
        <div class="logo-icon">âš•</div>
        <span>RAGnosis</span>
      </div>
      <nav>
        <ul>
          <li><a href="index.html">Home</a></li>
          <li><a href="diagnosis.html" class="active">Diagnosis Chatbot</a></li>
          <li><a href="contact.html">Contact</a></li>
        </ul>
      </nav>
    </div>
  </header>

  <main class="main-content">
    <h1 style="text-align:center; margin-top: 20px;">Smart Diagnosis Chat</h1>

    <div class="chat-container">
      <!-- Sidebar -->
      <div class="chat-sidebar">
        <div class="chat-sidebar-header">
          <h3>Chat History</h3>
          <button id="newChatBtn" title="New Chat" style="background:none;border:none;font-size:20px;cursor:pointer;">âž•</button>
        </div>
        <div class="chat-sidebar-list" id="chatHistory"></div>
      </div>

      <!-- Chat Area -->
      <div class="chat-main">
        <div class="chat-messages" id="chatMessages">
          <div class="empty-chat" id="emptyChat">
            <h2>Start a new diagnosis</h2>
            <p>Click the âž• button in the sidebar to begin.</p>
          </div>
        </div>
        <div class="chat-input-container">
          <textarea id="userInput" placeholder="Describe your symptoms here..."></textarea>
          <button id="sendBtn">Send</button>
        </div>
      </div>
    </div>
  </main>



  <script>
    // === Basic Local Chat Logic (no Google API) ===
    const chatHistoryEl = document.getElementById('chatHistory');
    const chatMessagesEl = document.getElementById('chatMessages');
    const userInputEl = document.getElementById('userInput');
    const sendBtn = document.getElementById('sendBtn');
    const newChatBtn = document.getElementById('newChatBtn');
    const emptyChatEl = document.getElementById('emptyChat');

    let chats = [];
    let activeChat = null;

    // Create new chat
    function startNewChat() {
      const newChat = {
        id: Date.now(),
        title: "New Diagnosis",
        messages: []
      };
      chats.push(newChat);
      activeChat = newChat;
      renderChatHistory();
      renderMessages();
    }

    // Render chat history
    function renderChatHistory() {
      chatHistoryEl.innerHTML = "";
      chats.forEach(chat => {
        const div = document.createElement('div');
        div.className = 'chat-sidebar-item' + (chat.id === activeChat?.id ? ' active' : '');
        div.innerHTML = `
          <span>${chat.title}</span>
          <button onclick="deleteChat(${chat.id})" style="border:none;background:none;color:#888;cursor:pointer;">ðŸ—‘</button>
        `;
        div.onclick = () => selectChat(chat.id);
        chatHistoryEl.appendChild(div);
      });
    }

    // Select chat
    function selectChat(id) {
      activeChat = chats.find(c => c.id === id);
      renderChatHistory();
      renderMessages();
    }

    // Delete chat
    function deleteChat(id) {
      chats = chats.filter(c => c.id !== id);
      if (activeChat?.id === id) activeChat = null;
      renderChatHistory();
      renderMessages();
    }

    // Render messages
    function renderMessages() {
      chatMessagesEl.innerHTML = "";
      if (!activeChat) {
        emptyChatEl.style.display = "flex";
        chatMessagesEl.appendChild(emptyChatEl);
        return;
      }
      emptyChatEl.style.display = "none";
      activeChat.messages.forEach(msg => {
        const msgDiv = document.createElement('div');
        msgDiv.className = `chat-message ${msg.sender}`;
        msgDiv.innerHTML = `<div class="chat-bubble ${msg.sender}">${msg.text}</div>`;
        chatMessagesEl.appendChild(msgDiv);
      });
      chatMessagesEl.scrollTop = chatMessagesEl.scrollHeight;
    }

    // Handle sending a message
    async function handleSend() {
      const text = userInputEl.value.trim();
      if (!text || !activeChat) return;

      const userMsg = { sender: "user", text };
      activeChat.messages.push(userMsg);
      userInputEl.value = "";
      renderMessages();

      // Show typing bubble
      const typingDiv = document.createElement("div");
      typingDiv.className = "chat-message bot";
      typingDiv.innerHTML = `<div class="chat-bubble bot">...</div>`;
      chatMessagesEl.appendChild(typingDiv);
      chatMessagesEl.scrollTop = chatMessagesEl.scrollHeight;

      try {
        // âœ… Wait for backend response
        const botReply = await generateBotResponse(text);

        chatMessagesEl.removeChild(typingDiv);

        activeChat.messages.push({ sender: "bot", text: botReply });

        if (activeChat.messages.length === 2) {
          activeChat.title = text.slice(0, 25) + "...";
        }

        renderChatHistory();
        renderMessages();

      } catch (err) {
        console.error("Error:", err);
        chatMessagesEl.removeChild(typingDiv);
        activeChat.messages.push({
          sender: "bot",
          text: "âŒ Could not connect to the diagnosis server.",
        });
        renderMessages();
      }
    }

async function generateBotResponse(input) {
  try {
    const response = await fetch("https://web-production-2e6ba.up.railway.app/predict", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        message: input,
        conversation: activeChat.messages.map(msg => ({
          patient: msg.sender === "user" ? msg.text : undefined,
          doctor: msg.sender === "bot" ? msg.text : undefined
        }))
      }),
    });

    // âœ… Check if response is ok
    if (!response.ok) {
      console.error("Server returned:", response.status);
      return "âš ï¸ Server error: " + response.status;
    }

    // âœ… Parse JSON
    const data = await response.json();
    console.log("Backend Response:", data);

    // âœ… Return the backend's message
    if (data && data.response) {
      return data.response;
    }

    if (data && data.error) {
      return "âš ï¸ " + data.error;
    }

    return "âš•ï¸ No diagnosis could be generated right now.";

  } catch (err) {
    console.error("Backend Error:", err);
    return "âŒ Unable to reach backend API.";
  }
}


    // Event listeners
    sendBtn.addEventListener('click', handleSend);
    userInputEl.addEventListener('keypress', e => {
      if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        handleSend();
      }
    });
    newChatBtn.addEventListener('click', startNewChat);

    // Initialize
    startNewChat();
  </script>
  <script src="./script.js"></script>
</body>
</html>
